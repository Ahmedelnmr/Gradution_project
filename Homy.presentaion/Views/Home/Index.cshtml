@model Homy.Application.Dtos.Admin.DashboardDto
@{
    ViewData["Title"] = "ููุญุฉ ุงูุชุญูู - ูููู";
}

<div class="dashboard-container">
    <!-- Hero Welcome Section -->
    <div class="hero-section">
        <div class="hero-content">
            <div class="hero-text">
                <h1 class="hero-title">
                    <i class="fas fa-home-lg-alt"></i>
                    ูุฑุญุจุงู ูู ููุญุฉ ุชุญูู ูููู
                </h1>
                <p class="hero-subtitle">ูุธุฑุฉ ุดุงููุฉ ุนูู ุฃุฏุงุก ุงูููุตุฉ ูุฅุญุตุงุฆูุงุช ุงููุธุงู ูู ุงูููุช ุงููุนูู</p>
            </div>
            <div class="hero-stats-mini">
                <div class="mini-stat">
                    <i class="fas fa-chart-line"></i>
                    <span>ููู ูุณุชูุฑ</span>
                </div>
                <div class="mini-stat">
                    <i class="fas fa-shield-check"></i>
                    <span>ุขูู ุชูุงูุงู</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Statistics Cards -->
    <div class="stats-grid">
        <!-- Users Card -->
        <div class="stat-card-modern stat-primary">
            <div class="stat-card-header">
                <div class="stat-icon-wrapper">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-badge">ุงููุณุชุฎุฏููู</div>
            </div>
            <div class="stat-card-body">
                <h2 class="stat-number" data-target="@Model.UsersCount">0</h2>
                <p class="stat-label">ุฅุฌูุงูู ุงููุณุชุฎุฏููู</p>
                <div class="stat-detail-row">
                    <span class="stat-detail"><i class="fas fa-check-circle"></i> @Model.ActiveUsersCount ูุดุท</span>
                    <span class="stat-detail"><i class="fas fa-user-check"></i> @Model.VerifiedAgentsCount ููุซู</span>
                </div>
            </div>
            <div class="stat-card-footer">
                <a href="@Url.Action("Index", "Users")" class="stat-link">ุนุฑุถ ุงูุชูุงุตูู <i class="fas fa-arrow-left"></i></a>
            </div>
        </div>

        <!-- Properties Card -->
        <div class="stat-card-modern stat-success">
            <div class="stat-card-header">
                <div class="stat-icon-wrapper">
                    <i class="fas fa-home"></i>
                </div>
                <div class="stat-badge">ุงูุนูุงุฑุงุช</div>
            </div>
            <div class="stat-card-body">
                <h2 class="stat-number" data-target="@Model.ActivePropertiesCount">0</h2>
                <p class="stat-label">ุนูุงุฑุงุช ูุดุทุฉ</p>
                <div class="stat-detail-row">
                    <span class="stat-detail"><i class="fas fa-clock"></i> @Model.PendingPropertiesCount ููุฏ ุงููุฑุงุฌุนุฉ</span>
                    <span class="stat-detail"><i class="fas fa-star"></i> @Model.FeaturedPropertiesCount ูููุฒ</span>
                </div>
            </div>
            <div class="stat-card-footer">
                <a href="@Url.Action("Index", "PropertyApproval")" class="stat-link">ุนุฑุถ ุงูุชูุงุตูู <i class="fas fa-arrow-left"></i></a>
            </div>
        </div>

        <!-- Subscriptions Card -->
        <div class="stat-card-modern stat-warning">
            <div class="stat-card-header">
                <div class="stat-icon-wrapper">
                    <i class="fas fa-crown"></i>
                </div>
                <div class="stat-badge">ุงูุงุดุชุฑุงูุงุช</div>
            </div>
            <div class="stat-card-body">
                <h2 class="stat-number" data-target="@Model.ActiveSubscriptionsCount">0</h2>
                <p class="stat-label">ุงุดุชุฑุงู ูุดุท</p>
                <div class="stat-detail-row">
                    <span class="stat-detail"><i class="fas fa-list"></i> @Model.TotalSubscriptionsCount ุฅุฌูุงูู</span>
                </div>
            </div>
            <div class="stat-card-footer">
                <a href="@Url.Action("Index", "UserSubscription")" class="stat-link">ุนุฑุถ ุงูุชูุงุตูู <i class="fas fa-arrow-left"></i></a>
            </div>
        </div>

        <!-- Revenue Card -->
        <div class="stat-card-modern stat-purple">
            <div class="stat-card-header">
                <div class="stat-icon-wrapper">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-badge">ุงูุฅูุฑุงุฏุงุช</div>
            </div>
            <div class="stat-card-body">
                <h2 class="stat-number">@Model.MonthlyRevenue.ToString("N0") EGP</h2>
                <p class="stat-label">ุงูุฅูุฑุงุฏุงุช ุงูุดูุฑูุฉ</p>
                <div class="stat-detail-row">
                    <span class="stat-detail"><i class="fas fa-coins"></i> @Model.TotalRevenue.ToString("N0") EGP ุฅุฌูุงูู</span>
                </div>
            </div>
            <div class="stat-card-footer">
                <a href="@Url.Action("Index", "Reports")" class="stat-link">ุนุฑุถ ุงูุชูุงุตูู <i class="fas fa-arrow-left"></i></a>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <h2 class="section-title">
            <i class="fas fa-chart-pie"></i>
            ุงูุชุญูููุงุช ูุงูุฑุณูู ุงูุจูุงููุฉ
        </h2>
        
        <div class="charts-grid">
            <!-- Users Distribution Chart -->
            <div class="chart-card">
                <div class="chart-card-header">
                    <h3 class="chart-title">ุชูุฒูุน ุงููุณุชุฎุฏููู</h3>
                    <div class="chart-actions">
                        <button class="chart-action-btn" title="ุชุญุฏูุซ">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="usersChart"></canvas>
                </div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #6366f1;"></span>
                        <span class="legend-label">ุฃุตุญุงุจ ุนูุงุฑุงุช</span>
                        <span class="legend-value" id="legend-owners">0%</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #8b5cf6;"></span>
                        <span class="legend-label">ุณูุงุณุฑุฉ</span>
                        <span class="legend-value" id="legend-agents">0%</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #ec4899;"></span>
                        <span class="legend-label">ูุฏูุฑู ุงููุธุงู</span>
                        <span class="legend-value" id="legend-admins">0%</span>
                    </div>
                </div>
            </div>

            <!-- Ads Distribution Chart -->
            <div class="chart-card">
                <div class="chart-card-header">
                    <h3 class="chart-title">ุชูุฒูุน ุงูุฅุนูุงูุงุช</h3>
                    <div class="chart-actions">
                        <button class="chart-action-btn" title="ุชุญุฏูุซ">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="adsChart"></canvas>
                </div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #10b981;"></span>
                        <span class="legend-label">ูุดุทุฉ</span>
                        <span class="legend-value" id="legend-active">0%</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #f59e0b;"></span>
                        <span class="legend-label">ููุฏ ุงููุฑุงุฌุนุฉ</span>
                        <span class="legend-value" id="legend-pending">0%</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #06b6d4;"></span>
                        <span class="legend-label">ูุจุงุนุฉ/ูุคุฌุฑุฉ</span>
                        <span class="legend-value" id="legend-sold">0%</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #ef4444;"></span>
                        <span class="legend-label">ูุฑููุถุฉ</span>
                        <span class="legend-value" id="legend-rejected">0%</span>
                    </div>
                </div>
            </div>

            <!-- Property Types Chart -->
            <div class="chart-card">
                <div class="chart-card-header">
                    <h3 class="chart-title">ุฃููุงุน ุงูุนูุงุฑุงุช</h3>
                    <div class="chart-actions">
                        <button class="chart-action-btn" title="ุชุญุฏูุซ">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="propertyTypesChart"></canvas>
                </div>
                <div class="chart-legend" id="property-types-legend">
                    <!-- Will be populated dynamically by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Access Section -->
    <div class="quick-access-section">
        <h2 class="section-title">
            <i class="fas fa-bolt"></i>
            ุงููุตูู ุงูุณุฑูุน
        </h2>
        
        <div class="quick-access-grid">
            <!-- Users Management -->
            <a href="@Url.Action("Index", "Users")" class="quick-access-card card-gradient-1">
                <div class="quick-card-icon">
                    <i class="fas fa-user-gear"></i>
                </div>
                <div class="quick-card-content">
                    <h3 class="quick-card-title">ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</h3>
                    <p class="quick-card-desc">ุนุฑุถุ ุชุนุฏููุ ูุฅุฏุงุฑุฉ ุญุณุงุจุงุช ุงููุณุชุฎุฏููู</p>
                    <div class="quick-card-stats">
                        <span><i class="fas fa-users"></i> @Model.UsersCount ูุณุชุฎุฏู</span>
                    </div>
                </div>
                <div class="quick-card-arrow">
                    <i class="fas fa-arrow-left"></i>
                </div>
            </a>

            <!-- Property Approval -->
            <a href="@Url.Action("Index", "PropertyApproval")" class="quick-access-card card-gradient-2">
                <div class="quick-card-icon">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="quick-card-content">
                    <h3 class="quick-card-title">ูุฑุงุฌุนุฉ ุงูุนูุงุฑุงุช</h3>
                    <p class="quick-card-desc">ุงูููุงููุฉ ุฃู ุฑูุถ ุงูุฅุนูุงูุงุช ุงููุนููุฉ</p>
                    <div class="quick-card-stats">
                        <span><i class="fas fa-clock"></i> @Model.PendingPropertiesCount ููุฏ ุงููุฑุงุฌุนุฉ</span>
                    </div>
                </div>
                <div class="quick-card-arrow">
                    <i class="fas fa-arrow-left"></i>
                </div>
            </a>

            <!-- Subscriptions -->
            <a href="@Url.Action("Index", "UserSubscription")" class="quick-access-card card-gradient-3">
                <div class="quick-card-icon">
                    <i class="fas fa-crown"></i>
                </div>
                <div class="quick-card-content">
                    <h3 class="quick-card-title">ุฅุฏุงุฑุฉ ุงูุงุดุชุฑุงูุงุช</h3>
                    <p class="quick-card-desc">ุงูุจุงูุงุช ูุงูุงุดุชุฑุงูุงุช ุงููุดุทุฉ</p>
                    <div class="quick-card-stats">
                        <span><i class="fas fa-star"></i> @Model.ActiveSubscriptionsCount ุงุดุชุฑุงู ูุดุท</span>
                    </div>
                </div>
                <div class="quick-card-arrow">
                    <i class="fas fa-arrow-left"></i>
                </div>
            </a>

            <!-- Packages -->
            <a href="@Url.Action("Index", "Packges")" class="quick-access-card card-gradient-4">
                <div class="quick-card-icon">
                    <i class="fas fa-box-open"></i>
                </div>
                <div class="quick-card-content">
                    <h3 class="quick-card-title">ุฅุฏุงุฑุฉ ุงูุจุงูุงุช</h3>
                    <p class="quick-card-desc">ุฅูุดุงุก ูุชุนุฏูู ุจุงูุงุช ุงูุงุดุชุฑุงู</p>
                    <div class="quick-card-stats">
                        <span><i class="fas fa-layer-group"></i> ุฅุฏุงุฑุฉ ุงูุจุงูุงุช</span>
                    </div>
                </div>
                <div class="quick-card-arrow">
                    <i class="fas fa-arrow-left"></i>
                </div>
            </a>

            <!-- Property Types -->
            <a href="@Url.Action("Index", "AdminPropertyTypes")" class="quick-access-card card-gradient-5">
                <div class="quick-card-icon">
                    <i class="fas fa-tags"></i>
                </div>
                <div class="quick-card-content">
                    <h3 class="quick-card-title">ุฃููุงุน ุงูุนูุงุฑุงุช</h3>
                    <p class="quick-card-desc">ุฅุฏุงุฑุฉ ุชุตูููุงุช ุงูุนูุงุฑุงุช</p>
                    <div class="quick-card-stats">
                        <span><i class="fas fa-list"></i> @Model.TotalPropertyTypes ููุน</span>
                    </div>
                </div>
                <div class="quick-card-arrow">
                    <i class="fas fa-arrow-left"></i>
                </div>
            </a>

            <!-- Projects -->
            <a href="@Url.Action("Index", "Projects")" class="quick-access-card card-gradient-6">
                <div class="quick-card-icon">
                    <i class="fas fa-building"></i>
                </div>
                <div class="quick-card-content">
                    <h3 class="quick-card-title">ุงููุดุงุฑูุน ูุงูููุจููุฏุงุช</h3>
                    <p class="quick-card-desc">ุฅุฏุงุฑุฉ ุงููุดุงุฑูุน ุงูุนูุงุฑูุฉ</p>
                    <div class="quick-card-stats">
                        <span><i class="fas fa-city"></i> @Model.TotalProjects ูุดุฑูุน</span>
                    </div>
                </div>
                <div class="quick-card-arrow">
                    <i class="fas fa-arrow-left"></i>
                </div>
            </a>
        </div>
    </div>
</div>

@{
    // Calculate percentages for charts - MUTUALLY EXCLUSIVE CATEGORIES
    var totalUsers = Model.UsersCount > 0 ? Model.UsersCount : 1;
    
    // Users Distribution BY ROLE (Owners, Agents, Admins) - Sum = 100%
    var ownersPercent = Math.Round((double)Model.OwnersCount / totalUsers * 100, 1);
    var agentsPercent = Math.Round((double)Model.AgentsCount / totalUsers * 100, 1);
    var adminsCount = totalUsers - Model.OwnersCount - Model.AgentsCount;
    var adminsPercent = Math.Round((double)adminsCount / totalUsers * 100, 1);
    
    // Ensure exact 100% (fix rounding errors)
    var userPercentSum = ownersPercent + agentsPercent + adminsPercent;
    if (userPercentSum != 100 && userPercentSum > 0)
    {
        // Adjust the largest category
        if (ownersPercent >= agentsPercent && ownersPercent >= adminsPercent)
            ownersPercent += (100 - userPercentSum);
        else if (agentsPercent >= adminsPercent)
            agentsPercent += (100 - userPercentSum);
        else
            adminsPercent += (100 - userPercentSum);
    }
    
    // Properties Distribution (Active, Pending, Sold/Rented, Rejected) - Sum = 100%
    var totalAds = Model.AdsCount > 0 ? Model.AdsCount : 1;
    var activeAdsPercent = Math.Round((double)Model.ActivePropertiesCount / totalAds * 100, 1);
    var pendingAdsPercent = Math.Round((double)Model.PendingPropertiesCount / totalAds * 100, 1);
    var soldRentedAdsPercent = Math.Round((double)Model.SoldOrRentedPropertiesCount / totalAds * 100, 1);
    var rejectedAdsPercent = Math.Round((double)Model.RejectedPropertiesCount / totalAds * 100, 1);
    
    // Ensure exact 100% for properties (fix rounding errors)
    var adsPercentSum = activeAdsPercent + pendingAdsPercent + soldRentedAdsPercent + rejectedAdsPercent;
    if (adsPercentSum != 100 && adsPercentSum > 0)
    {
        // Adjust the largest category
        if (activeAdsPercent >= pendingAdsPercent && activeAdsPercent >= soldRentedAdsPercent && activeAdsPercent >= rejectedAdsPercent)
            activeAdsPercent += (100 - adsPercentSum);
        else if (pendingAdsPercent >= soldRentedAdsPercent && pendingAdsPercent >= rejectedAdsPercent)
            pendingAdsPercent += (100 - adsPercentSum);
        else if (soldRentedAdsPercent >= rejectedAdsPercent)
            soldRentedAdsPercent += (100 - adsPercentSum);
        else
            rejectedAdsPercent += (100 - adsPercentSum);
    }
    
    // Property types percentages
    var propertyTypesJson = Newtonsoft.Json.JsonConvert.SerializeObject(Model.PropertyTypesDistribution);
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Pass server-side data to JavaScript - REAL DATA FROM SERVER
        const dashboardData = {
            users: {
                owners: @ownersPercent,
                ownersCount: @Model.OwnersCount,
                agents: @agentsPercent,
                agentsCount: @Model.AgentsCount,
                admins: @adminsPercent,
                adminsCount: @adminsCount
            },
            properties: {
                active: @activeAdsPercent,
                activeCount: @Model.ActivePropertiesCount,
                pending: @pendingAdsPercent,
                pendingCount: @Model.PendingPropertiesCount,
                soldRented: @soldRentedAdsPercent,
                soldRentedCount: @Model.SoldOrRentedPropertiesCount,
                rejected: @rejectedAdsPercent,
                rejectedCount: @Model.RejectedPropertiesCount
            },
            propertyTypes: @Html.Raw(propertyTypesJson)
        };
        
        console.log('๐ Dashboard Data Loaded:', dashboardData);
        console.log('โ Users % Sum:', dashboardData.users.owners + dashboardData.users.agents + dashboardData.users.admins);
        console.log('โ Properties % Sum:', dashboardData.properties.active + dashboardData.properties.pending + dashboardData.properties.soldRented + dashboardData.properties.rejected);
    </script>
    <script src="~/js/dashboard-charts.js"></script>
}
