using Homy.Domin.Contract_Repo;
using Homy.Domin.Contract_Service;
using Homy.Domin.models;
using Homy.Infurastructure.Data;
using Homy.Infurastructure.Repository;
using Homy.Infurastructure.Service;
using Homy.Infurastructure.Unitofworks;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
namespace Homy.presentaion
{
    public class Program
    {
        public static void Main(string[] args)
        {
            var builder = WebApplication.CreateBuilder(args);

            // Add services to the container.
            builder.Services.AddControllersWithViews();

            builder.Services.AddIdentity<User, IdentityRole<Guid>>()
                .AddEntityFrameworkStores<HomyContext>()
                .AddDefaultTokenProviders();

            builder.Services.AddDbContext<HomyContext>(options =>
            options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

            // Register Repositories
            builder.Services.AddScoped(typeof(IGenric_Repo<>), typeof(Genric_Repo<>));
            builder.Services.AddScoped<IProperty_Repo, Property_Repo>();
            builder.Services.AddScoped<IUnitofwork, Unitofwork>();
            builder.Services.AddScoped<IUser_Service, User_Service>();

            var app = builder.Build();

            // Configure the HTTP request pipeline.
            if (!app.Environment.IsDevelopment())
            {
                app.UseExceptionHandler("/Home/Error");
            }
            app.UseStaticFiles();

            app.UseRouting();

            app.UseAuthorization();

            app.MapControllerRoute(
                name: "default",
                pattern: "{controller=Home}/{action=Index}/{id?}");

            using (var scope = app.Services.CreateScope())
            {
                var services = scope.ServiceProvider;

                try
                {
                    var userManager = services.GetRequiredService<UserManager<User>>();
                    var roleManager = services.GetRequiredService<RoleManager<IdentityRole<Guid>>>();

                     SeedUsersAsync(userManager, roleManager);
                }
                catch (Exception ex)
                {
                    var logger = services.GetRequiredService<ILogger<Program>>();
                    logger.LogError(ex, "حدث خطأ أثناء إنشاء المستخدمين");
                }
            }

            // ============================================
            // Method لإنشاء المستخدمين
            // ============================================

            async Task SeedUsersAsync(UserManager<User> userManager, RoleManager<IdentityRole<Guid>> roleManager)
            {
                // 1️⃣ إنشاء الأدوار أولاً
                string[] roles = { "Admin", "Agent", "Owner" };
                foreach (var role in roles)
                {
                    if (!await roleManager.RoleExistsAsync(role))
                    {
                        await roleManager.CreateAsync(new IdentityRole<Guid>(role));
                    }
                }

                // 2️⃣ إنشاء Admin (لو مش موجود)
                if (await userManager.FindByEmailAsync("admin@homy.com") == null)
                {
                    var admin = new User
                    {
                        UserName = "admin",
                        Email = "admin@homy.com",
                        FullName = "مدير النظام",
                        PhoneNumber = "01000000000",
                        Role = UserRole.Admin,
                        IsVerified = true,
                        IsActive = true,
                        EmailConfirmed = true
                    };

                    var result = await userManager.CreateAsync(admin, "Admin@123");
                    if (result.Succeeded)
                    {
                        await userManager.AddToRoleAsync(admin, "Admin");
                    }
                }

                // 3️⃣ إنشاء السماسرة (Agents)

                // سمسار 1 - موثق
                if (await userManager.FindByEmailAsync("ahmed@homy.com") == null)
                {
                    var agent1 = new User
                    {
                        UserName = "ahmed_agent",
                        Email = "ahmed@homy.com",
                        FullName = "أحمد محمد السمسار",
                        PhoneNumber = "01012345678",
                        WhatsAppNumber = "01012345678",
                        Role = UserRole.Agent,
                        IsVerified = true, // موثق
                        IsActive = true,
                        EmailConfirmed = true
                    };

                    var result = await userManager.CreateAsync(agent1, "Agent@123");
                    if (result.Succeeded)
                    {
                        await userManager.AddToRoleAsync(agent1, "Agent");
                    }
                }

                // سمسار 2 - غير موثق
                if (await userManager.FindByEmailAsync("mohamed@homy.com") == null)
                {
                    var agent2 = new User
                    {
                        UserName = "mohamed_agent",
                        Email = "mohamed@homy.com",
                        FullName = "محمد علي السمسار",
                        PhoneNumber = "01123456789",
                        WhatsAppNumber = "01123456789",
                        Role = UserRole.Agent,
                        IsVerified = false, // غير موثق
                        IsActive = true,
                        EmailConfirmed = true
                    };

                    var result = await userManager.CreateAsync(agent2, "Agent@123");
                    if (result.Succeeded)
                    {
                        await userManager.AddToRoleAsync(agent2, "Agent");
                    }
                }

                // سمسار 3 - غير موثق
                if (await userManager.FindByEmailAsync("khaled@homy.com") == null)
                {
                    var agent3 = new User
                    {
                        UserName = "khaled_agent",
                        Email = "khaled@homy.com",
                        FullName = "خالد حسن السمسار",
                        PhoneNumber = "01234567890",
                        WhatsAppNumber = "01234567890",
                        Role = UserRole.Agent,
                        IsVerified = false, // غير موثق
                        IsActive = true,
                        EmailConfirmed = true
                    };

                    var result = await userManager.CreateAsync(agent3, "Agent@123");
                    if (result.Succeeded)
                    {
                        await userManager.AddToRoleAsync(agent3, "Agent");
                    }
                }

                // سمسار 4 - موثق
                if (await userManager.FindByEmailAsync("hassan@homy.com") == null)
                {
                    var agent4 = new User
                    {
                        UserName = "hassan_agent",
                        Email = "hassan@homy.com",
                        FullName = "حسن إبراهيم السمسار",
                        PhoneNumber = "01345678901",
                        WhatsAppNumber = "01345678901",
                        Role = UserRole.Agent,
                        IsVerified = true, // موثق
                        IsActive = true,
                        EmailConfirmed = true
                    };

                    var result = await userManager.CreateAsync(agent4, "Agent@123");
                    if (result.Succeeded)
                    {
                        await userManager.AddToRoleAsync(agent4, "Agent");
                    }
                }

                // سمسار 5 - موثق لكن معطل
                if (await userManager.FindByEmailAsync("ali@homy.com") == null)
                {
                    var agent5 = new User
                    {
                        UserName = "ali_agent",
                        Email = "ali@homy.com",
                        FullName = "علي أحمد السمسار",
                        PhoneNumber = "01456789012",
                        WhatsAppNumber = "01456789012",
                        Role = UserRole.Agent,
                        IsVerified = true, // موثق
                        IsActive = false, // معطل
                        EmailConfirmed = true
                    };

                    var result = await userManager.CreateAsync(agent5, "Agent@123");
                    if (result.Succeeded)
                    {
                        await userManager.AddToRoleAsync(agent5, "Agent");
                    }
                }

                // 4️⃣ إنشاء أصحاب العقارات (Owners)

                // مالك 1
                if (await userManager.FindByEmailAsync("abdullah@homy.com") == null)
                {
                    var owner1 = new User
                    {
                        UserName = "abdullah_owner",
                        Email = "abdullah@homy.com",
                        FullName = "عبدالله سعيد",
                        PhoneNumber = "01567890123",
                        Role = UserRole.Owner,
                        IsVerified = true,
                        IsActive = true,
                        EmailConfirmed = true
                    };

                    var result = await userManager.CreateAsync(owner1, "Owner@123");
                    if (result.Succeeded)
                    {
                        await userManager.AddToRoleAsync(owner1, "Owner");
                    }
                }

                // مالك 2
                if (await userManager.FindByEmailAsync("mustafa@homy.com") == null)
                {
                    var owner2 = new User
                    {
                        UserName = "mustafa_owner",
                        Email = "mustafa@homy.com",
                        FullName = "مصطفى أحمد",
                        PhoneNumber = "01678901234",
                        Role = UserRole.Owner,
                        IsVerified = true,
                        IsActive = true,
                        EmailConfirmed = true
                    };

                    var result = await userManager.CreateAsync(owner2, "Owner@123");
                    if (result.Succeeded)
                    {
                        await userManager.AddToRoleAsync(owner2, "Owner");
                    }
                }

                // مالك 3
                if (await userManager.FindByEmailAsync("omar@homy.com") == null)
                {
                    var owner3 = new User
                    {
                        UserName = "omar_owner",
                        Email = "omar@homy.com",
                        FullName = "عمر محمود",
                        PhoneNumber = "01789012345",
                        Role = UserRole.Owner,
                        IsVerified = true,
                        IsActive = true,
                        EmailConfirmed = true
                    };

                    var result = await userManager.CreateAsync(owner3, "Owner@123");
                    if (result.Succeeded)
                    {
                        await userManager.AddToRoleAsync(owner3, "Owner");
                    }
                }

                // مالك 4
                if (await userManager.FindByEmailAsync("youssef@homy.com") == null)
                {
                    var owner4 = new User
                    {
                        UserName = "youssef_owner",
                        Email = "youssef@homy.com",
                        FullName = "يوسف حسين",
                        PhoneNumber = "01890123456",
                        Role = UserRole.Owner,
                        IsVerified = true,
                        IsActive = true,
                        EmailConfirmed = true
                    };

                    var result = await userManager.CreateAsync(owner4, "Owner@123");
                    if (result.Succeeded)
                    {
                        await userManager.AddToRoleAsync(owner4, "Owner");
                    }
                }

                // مالك 5
                if (await userManager.FindByEmailAsync("karim@homy.com") == null)
                {
                    var owner5 = new User
                    {
                        UserName = "karim_owner",
                        Email = "karim@homy.com",
                        FullName = "كريم عبدالله",
                        PhoneNumber = "01901234567",
                        Role = UserRole.Owner,
                        IsVerified = true,
                        IsActive = true,
                        EmailConfirmed = true
                    };

                    var result = await userManager.CreateAsync(owner5, "Owner@123");
                    if (result.Succeeded)
                    {
                        await userManager.AddToRoleAsync(owner5, "Owner");
                    }
                }

                Console.WriteLine("✅ تم إنشاء المستخدمين بنجاح!");
            }
            app.Run();
        }
    }
}
